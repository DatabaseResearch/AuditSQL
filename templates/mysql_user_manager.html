{% extends 'base.html' %}
{% load staticfiles %}

{% block link_css %}
{% endblock %}

{% block right_content %}
    <div class="row">
        <div class="col-md-12">
            <div class="box box-info">
                <div class="box-header">
                    <div class="mailbox-read-info">
                        <h3 class="box-title"><i class="fa fa-cog"></i> 账号预览</h3>
                    </div>
                </div>
                <div class="box-body">
                    <div class="col-sm-12">
                        <div id="toolbar" class="btn-group">
                            <div class="form-group">
                                <select id="select_env" name="host" onchange="refresh_table()"
                                        required
                                        class="form-control selectpicker" title="选择主机...">
                                </select>
                            </div>
                        </div>
                    </div>
                    <table id="table"></table>
                </div>
                <!-- /.box -->
            </div>
        </div>
    </div>

{% endblock %}

{% block link_javascripts %}
    <script>
        /**
         * 初始化bootstrap-table，生成表格
         */
        var $table = $('#table');
        $(function () {
            $table.bootstrapTable({
                method: 'get',
                dataType: 'json',
                url: "{% url 'p_mysql_user_manager' %}",
                search: true,
                cache: false,
                showRefresh: true,
                toolbar: '#toolbar',
                sidePagination: "client",
                classes: 'table table-hover',
                idField: 'id',
                treeShowField: 'user',
                parentIdField: 'pid',
                formatLoadingMessage: function () {
                    return "请稍等，正在加载中...";
                },
                formatNoMatches: function () {  //没有匹配的结果
                    return '没有查询到记录，请检查是否能够访问目标主机';
                },
                queryParams: function (params) {
                    return {
                        'host': $("#select_env").val()
                    }
                },
                onSearch: function (text) {
                    refresh_table()
                },
                onLoadSuccess: function (data) {
                    $table.treegrid({
                        treeColumn: 1,
                        expanderExpandedClass: 'glyphicon glyphicon-chevron-down',
                        expanderCollapsedClass: 'glyphicon glyphicon-chevron-right',
                        onChange: function () {
                            $table.bootstrapTable('resetWidth');
                        }
                    });
                },
                onLoadError: function (status) {
                    $table.bootstrapTable('removeAll');
                },
                columns: [
                    {
                        field: 'ck',
                        checkbox: true
                    },
                    {
                        field: 'user',
                        title: '用户',
                        width: '20%'
                    },
                    {
                        field: 'host',
                        title: '主机'
                    },
                    {
                        field: 'schema',
                        title: 'schema'
                    },
                    {
                        field: 'password',
                        title: '密码'
                    },
                    {
                        field: 'password_expired',
                        title: '密码过期',
                        align: 'center',
                        formatter: function (value) {
                            if (value === 'N') {
                                return '<span class="label label-success">正常</span>'
                            } else if (value === 'Y') {
                                return '<span class="label label-success">过期</span>'
                            }
                            else {
                                return ''
                            }
                        }
                    },
                    {
                        field: 'privileges',
                        title: '权限'
                    }
                ]
            })
        });

        function refresh_table() {
            $table.bootstrapTable('refresh', {silent: true});
        }

        /**
         * 获取用户所在项目组的所有主机信息
         */
        $(function () {
            $.ajax({
                url: '{% url 'p_host_config' %}',
                type: 'GET',
                dataType: 'json',
                timeout: 5000,
                cache: false,
                success: function (data) {
                    var html = '';
                    $.each(data, function (index, row) {
                        var host = row.host;
                        var comment = row.comment;
                        html += "<option selected value=" + host + ">" + comment + "</option>"
                    });
                    $('#select_env').append(html);
                    $('.selectpicker').selectpicker('refresh')
                }
            })
        });

    </script>
{% endblock %}